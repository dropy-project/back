datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum MediaType {
  NONE
  TEXT
  PICTURE
  VIDEO
  MUSIC
}

model User {
  id  Int    @id @default(autoincrement())
  uid String @unique

  username     String   @unique
  displayName  String
  registerDate DateTime @default(now())
  deviceToken  String?

  emittedDropies   Dropy[] @relation("emittedDropies")
  retrievedDropies Dropy[] @relation("retrievedDropies")

  lastSeenDate              DateTime @default(now())
  lastSeenLocationLongitude Float    @default(0)
  lastSeenLocationLatitude  Float    @default(0)

  conversations ChatConversation[]
  chatMessages  ChatMessage[]
}

model Dropy {
  id           Int      @id @default(autoincrement())
  creationDate DateTime @default(now())

  emitter   User @relation("emittedDropies", fields: [emitterId], references: [id], map: "emitterId")
  emitterId Int

  retrieverId  Int?
  retriever    User?     @relation("retrievedDropies", fields: [retrieverId], references: [id], map: "retrieverId")
  retrieveDate DateTime?

  latitude  Float
  longitude Float

  filePath  String?
  mediaData String?
  mediaType MediaType @default(NONE)

  chatConversation   ChatConversation? @relation(fields: [chatConversationId], references: [id])
  chatConversationId Int?

  chatMessage        ChatMessage[]
}

model ChatConversation {
  id           Int      @id @default(autoincrement())
  creationDate DateTime @default(now())
  closed       Boolean  @default(false)

  users User[]

  dropies Dropy[]

  messages ChatMessage[]
}

model ChatMessage {
  id   Int      @id @default(autoincrement())
  date DateTime @default(now())

  conversation   ChatConversation @relation(fields: [conversationId], references: [id])
  conversationId Int

  sender   User @relation(fields: [senderId], references: [id])
  senderId Int

  content String?
  dropy   Dropy?  @relation(fields: [dropyId], references: [id])

  read    Boolean @default(false)
  dropyId Int?
}
